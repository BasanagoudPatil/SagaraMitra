<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Boat Booking Payment</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
<h2>Confirm Your Boat Booking</h2>
<button id="pay-button">Pay Now</button>

<script>
    const boatType = localStorage.getItem("boatType") || "public";
    const userId = localStorage.getItem("userId");
    const boatId = localStorage.getItem("boatId");
    const slotId = localStorage.getItem("slotId");
    const bookingDate = localStorage.getItem("bookingDate");
    const seatCount = parseInt(localStorage.getItem("seatCount")) || 1;

    const amount = boatType === "public" ? 500 * seatCount : 1500;

    document.getElementById('pay-button').onclick = function () {
        fetch(`http://localhost:8081/api/payments/create-order?boatId=${boatId}&bookingDate=${bookingDate}&slotId=${slotId}&seats=${seatCount}&isPrivate=${boatType === "private"}&amount=${amount}&currency=INR`, {
            method: 'POST'
        })
        .then(res => res.json())
        .then(order => {
            if (order.error) {
                alert(order.error);
                return;
            }

            const options = {
                key: "rzp_test_QLskUZfgxNvznF",
                amount: order.amount,
                currency: order.currency,
                name: "SagaraMitra",
                description: "Boat Booking Payment",
                order_id: order.id,

                handler: function (response) {
                    const bookingData = boatType === "public"
                        ? {
                            userId: userId,
                            boatId: boatId,
                            slotId: slotId,
                            date: bookingDate,
                            seatCount: seatCount
                          }
                        : {
                            userId: userId,
                            boatId: boatId,
                            slotId: slotId,
                            date: bookingDate
                          };

                    console.log("üì§ Sending bookingData:", bookingData);

                    const url = `http://localhost:8081/api/bookings/${boatType}/confirm`;

                    fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(bookingData)
                    })
                    .then(r => r.json())
                    .then(res => {
                        console.log("üì• Booking API Response:", res);
                        if (res.status === "success") {
                            window.location.href = "booking-success.html";
                        } else {
                            window.location.href = "payment-failed.html";
                        }
                    })
                    .catch(err => {
                        console.error("‚ùå Booking API Error:", err);
                        window.location.href = "payment-failed.html";
                    });
                }
            };

            const rzp = new Razorpay(options);

            rzp.on("payment.failed", function (resp) {
                console.error("‚ùå Payment failed:", resp.error);
                window.location.href = "payment-failed.html";
            });

            rzp.open();
        })
        .catch(err => {
            console.error("‚ùå Payment API error:", err);
            window.location.href = "payment-failed.html";
        });
    };
</script>
</body>
</html>
